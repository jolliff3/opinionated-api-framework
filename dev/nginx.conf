events {
    worker_connections 1024;
}

http {
    # Upstream definitions for each service
    upstream userservice {
        server userservice:80;
    }
    
    upstream messageservice {
        server messageservice:80;
    }
    
    upstream authservice {
        server authservice:80;
    }

    # Default server to handle requests that don't match any host
    server {
        listen 80 default_server;
        server_name _;
        return 404;
    }

    server {
        listen 80;
        server_name auth.localhost;

        location = /.well-known/jwks.json {
            limit_except GET {
                deny all;
            }
            proxy_pass http://authservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }

        location = /users:signUp {
            limit_except POST {
                deny all;
            }
            proxy_pass http://authservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }

        # POST /users:signIn -> authservice
        location = /users:signIn {
            limit_except POST {
                deny all;
            }
            proxy_pass http://authservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }
    }

    server {
        listen 80;
        server_name admin.localhost;

        # GET /users/{user-id} -> userservice
        location ~ ^/users/\w+$ {
            limit_except GET {
                deny all;
            }
            proxy_pass http://userservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }

        # POST /users and GET /users -> userservice
        location = /users {
            limit_except GET POST {
                deny all;
            }
            proxy_pass http://userservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }
    }

    server {
        listen 80;
        server_name public.localhost;

        # GET /public/users/count -> userservice
        location = /public/users/count {
            limit_except GET {
                deny all;
            }
            proxy_pass http://userservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }
    }

    # Host 4: user.localhost
    server {
        listen 80;
        server_name user.localhost;

        # GET /users/current -> userservice
        location = /users/current {
            limit_except GET {
                deny all;
            }
            proxy_pass http://userservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }

        # GET /users/current/messages -> messageservice
        location = /users/current/messages {
            limit_except GET {
                deny all;
            }
            proxy_pass http://messageservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }

        location = /users/current/messages:send {
            limit_except POST {
                deny all;
            }
            proxy_pass http://messageservice;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Proxy-Auth "secure-proxy-token";
        }
    }
}