services:
  loadbalancer:
    image: nginx:latest
    container_name: loadbalancer
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - userservice
      - messageservice
      - authservice
  userservice:
    build:
      context: ../.
      dockerfile: Dockerfile
    image: local/userservice:latest
    container_name: userservice
    command: ./services/userService/main.js
    environment:
      - PORT=80
      - NODE_ENV=development
      - TOKEN_JWKS_URI=http://authservice/.well-known/jwks.json
      - TOKEN_ISSUER=http://authservice
      - TOKEN_AUDIENCE=opinionated-api-framework
    ports:
      - "4001:80"
  messageservice:
    build:
      context: ../.
      dockerfile: Dockerfile
    image: local/userservice:latest
    container_name: messageservice
    command: ./services/messageService/main.js
    environment:
      - PORT=80
      - NODE_ENV=development
      - TOKEN_ISSUER=http://authservice
      - TOKEN_AUDIENCE=opinionated-api-framework
    ports:
      - "4002:80"
  authservice:
    build:
      context: ../.
      dockerfile: Dockerfile
    user: "0"
    image: local/authservice:latest
    container_name: authservice
    command: "./services/authService/main.js"
    environment:
      - PORT=80
      - NODE_ENV=development
      - KEY_DIR=/keys
      - MINTED_TOKEN_ISSUER=http://authservice
      - MINTED_TOKEN_AUDIENCE=opinionated-api-framework
      - TOKEN_ISSUER=http://authservice
      - TOKEN_AUDIENCE=opinionated-api-framework
    ports:
      - "4003:80"
    volumes:
      - authservice-keys:/keys:rw

volumes:
  authservice-keys:
